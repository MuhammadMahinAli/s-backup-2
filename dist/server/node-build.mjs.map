{"version":3,"file":"node-build.mjs","sources":["../../server/routes/demo.ts","../../server/models/Post.ts","../../server/models/Comment.ts","../../server/lib/mongodb.ts","../../shared/schemas.ts","../../server/lib/rateLimiter.ts","../../server/routes/post.ts","../../server/routes/feed.ts","../../server/routes/comment.ts","../../server/routes/report.ts","../../server/routes/delete.ts","../../server/routes/chat.ts","../../server/index.ts","../../server/node-build.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { DemoResponse } from \"../../shared/api\";\r\n\r\nexport const handleDemo: RequestHandler = (req, res) => {\r\n  const response: DemoResponse = {\r\n    message: \"Hello from Express server\",\r\n  };\r\n  res.status(200).json(response);\r\n};\r\n","import mongoose, { Schema, Document } from 'mongoose';\r\n\r\nexport interface IPost extends Document {\r\n  nickname: string;\r\n  text: string;\r\n  imageUrl?: string; // Legacy single image support (deprecated - use images array)\r\n  images: Array<{ url: string; publicId: string }>; // Multi-image support\r\n  authorAnonId?: string; // Anonymous author identifier from client (optional for backward compatibility)\r\n  createdAt: Date;\r\n  topics: string[];\r\n  blurRequested: boolean;\r\n  contentType: 'text' | 'image';\r\n  commentCount: number;\r\n  reportsCount: number;\r\n  status: 'auto' | 'pending';\r\n}\r\n\r\nconst PostSchema = new Schema<IPost>(\r\n  {\r\n    nickname: {\r\n      type: String,\r\n      required: [true, 'Nickname is required'],\r\n      trim: true,\r\n    },\r\n    text: {\r\n      type: String,\r\n      required: [true, 'Text is required'],\r\n      minlength: [20, 'Text must be at least 20 characters'],\r\n      maxlength: [1000, 'Text must not exceed 1000 characters'],\r\n      trim: true,\r\n    },\r\n    imageUrl: {\r\n      type: String,\r\n      trim: true,\r\n      // Legacy field - prefer using 'images' array for new posts\r\n    },\r\n    images: {\r\n      type: [\r\n        {\r\n          url: { type: String, required: true },\r\n          publicId: { type: String, required: true },\r\n        },\r\n      ],\r\n      default: [],\r\n    },\r\n    authorAnonId: {\r\n      type: String,\r\n      required: false, // Optional for backward compatibility with existing posts\r\n      index: true, // Index for efficient author queries\r\n      trim: true,\r\n    },\r\n    createdAt: {\r\n      type: Date,\r\n      default: Date.now,\r\n    },\r\n    topics: {\r\n      type: [String],\r\n      default: [],\r\n    },\r\n    blurRequested: {\r\n      type: Boolean,\r\n      default: false,\r\n    },\r\n    contentType: {\r\n      type: String,\r\n      enum: ['text', 'image'],\r\n      default: 'text',\r\n    },\r\n    commentCount: {\r\n      type: Number,\r\n      default: 0,\r\n      min: 0,\r\n    },\r\n    reportsCount: {\r\n      type: Number,\r\n      default: 0,\r\n      min: 0,\r\n    },\r\n    status: {\r\n      type: String,\r\n      enum: ['auto', 'pending'],\r\n      default: 'auto',\r\n    },\r\n  },\r\n  {\r\n    timestamps: false, // We're managing createdAt manually\r\n  }\r\n);\r\n\r\n// Create index on createdAt in descending order for efficient querying\r\nPostSchema.index({ createdAt: -1 });\r\n\r\n// Compound index for author-based queries with time sorting\r\nPostSchema.index({ authorAnonId: 1, createdAt: -1 });\r\n\r\n// Export the model\r\nexport const Post = mongoose.model<IPost>('Post', PostSchema);\r\n\r\n","import mongoose, { Schema, Document, Types } from 'mongoose';\n\nexport interface IComment extends Document {\n  postId: Types.ObjectId;\n  nickname: string;\n  text: string;\n  createdAt: Date;\n}\n\nconst CommentSchema = new Schema<IComment>(\n  {\n    postId: {\n      type: Schema.Types.ObjectId,\n      ref: 'Post',\n      required: [true, 'Post ID is required'],\n    },\n    nickname: {\n      type: String,\n      required: [true, 'Nickname is required'],\n      trim: true,\n    },\n    text: {\n      type: String,\n      required: [true, 'Text is required'],\n      minlength: [5, 'Text must be at least 5 characters'],\n      maxlength: [500, 'Text must not exceed 500 characters'],\n      trim: true,\n    },\n    createdAt: {\n      type: Date,\n      default: Date.now,\n    },\n  },\n  {\n    timestamps: false, // We're managing createdAt manually\n  }\n);\n\n// Create index on postId in ascending order for efficient querying\nCommentSchema.index({ postId: 1 });\n\n// Export the model\nexport const Comment = mongoose.model<IComment>('Comment', CommentSchema);\n\n","import mongoose from 'mongoose';\n\nif (!process.env.MONGODB_URI) {\n  throw new Error('Please define the MONGODB_URI environment variable');\n}\n\nif (!process.env.MONGODB_DB) {\n  throw new Error('Please define the MONGODB_DB environment variable');\n}\n\nconst MONGODB_URI = process.env.MONGODB_URI;\nconst MONGODB_DB = process.env.MONGODB_DB;\n\ninterface MongooseCache {\n  conn: typeof mongoose | null;\n  promise: Promise<typeof mongoose> | null;\n}\n\n// Extend the global type to include our mongoose cache\ndeclare global {\n  // eslint-disable-next-line no-var\n  var mongoose: MongooseCache | undefined;\n}\n\n// Create a cached connection object to prevent multiple connections during hot reload\nlet cached: MongooseCache = global.mongoose || { conn: null, promise: null };\n\nif (!global.mongoose) {\n  global.mongoose = cached;\n}\n\n/**\n * Connect to MongoDB using Mongoose\n * Uses a cached connection to prevent multiple connections during hot reload\n */\nexport async function connectToDatabase(): Promise<typeof mongoose> {\n  // Return existing connection if available\n  if (cached.conn) {\n    return cached.conn;\n  }\n\n  // Return existing connection promise if one is in progress\n  if (!cached.promise) {\n    const opts = {\n      bufferCommands: false,\n      dbName: MONGODB_DB,\n    };\n\n    cached.promise = mongoose.connect(MONGODB_URI, opts).then((mongooseInstance) => {\n      console.log('âœ… MongoDB connected successfully');\n      return mongooseInstance;\n    });\n  }\n\n  try {\n    cached.conn = await cached.promise;\n  } catch (e) {\n    cached.promise = null;\n    throw e;\n  }\n\n  return cached.conn;\n}\n\n/**\n * Get the MongoDB database instance\n * Ensures connection is established before returning the database\n */\nexport async function getDatabase() {\n  const mongooseInstance = await connectToDatabase();\n  return mongooseInstance.connection.db;\n}\n\n/**\n * Export the mongoose connection for direct access\n */\nexport { mongoose };\n\n/**\n * Disconnect from MongoDB (useful for cleanup in tests or graceful shutdown)\n */\nexport async function disconnectFromDatabase(): Promise<void> {\n  if (cached.conn) {\n    await cached.conn.disconnect();\n    cached.conn = null;\n    cached.promise = null;\n    console.log('âœ… MongoDB disconnected successfully');\n  }\n}\n\n","/**\r\n * Shared Zod schemas for validation\r\n * Can be used by both client and server\r\n */\r\n\r\nimport { z } from 'zod';\r\n\r\n// Image schema for post images\r\nexport const ImageZ = z.object({\r\n  url: z.string().url('Invalid image URL'),\r\n  publicId: z.string().min(1, 'Public ID is required')\r\n});\r\n\r\n// Post creation schema\r\nexport const CreatePostZ = z.object({\r\n  nickname: z.string().trim().max(40, 'Nickname must not exceed 40 characters').default('Anonymous'),\r\n  text: z.string().trim().min(20, 'Text must be at least 20 characters').max(1000, 'Text must not exceed 1000 characters'),\r\n  images: z.array(ImageZ).max(4, 'Maximum 4 images allowed').default([]),\r\n  blurRequested: z.boolean().optional().default(false),\r\n  topics: z.array(z.string()).optional().default([]),\r\n  // Legacy field (optional for backward compatibility)\r\n  imageUrl: z.string().optional(),\r\n  // Client may send this, but server will prefer reading from cookie\r\n  authorAnonId: z.string().optional(),\r\n});\r\n\r\n// Comment creation schema\r\nexport const CreateCommentZ = z.object({\r\n  postId: z.string().min(1, 'Post ID is required'),\r\n  nickname: z.string().trim().max(40, 'Nickname must not exceed 40 characters').default('Anonymous'),\r\n  text: z.string().trim().min(5, 'Comment must be at least 5 characters').max(500, 'Comment must not exceed 500 characters'),\r\n});\r\n\r\n// Report post schema\r\nexport const ReportPostZ = z.object({\r\n  postId: z.string().min(1, 'Post ID is required'),\r\n});\r\n\r\n// Type exports for TypeScript inference\r\nexport type ImageSchema = z.infer<typeof ImageZ>;\r\nexport type CreatePostSchema = z.infer<typeof CreatePostZ>;\r\nexport type CreateCommentSchema = z.infer<typeof CreateCommentZ>;\r\nexport type ReportPostSchema = z.infer<typeof ReportPostZ>;\r\n\r\n","/**\r\n * In-memory rate limiter for post creation\r\n * Tracks posts per anonymous ID to prevent abuse\r\n */\r\n\r\ninterface RateLimitEntry {\r\n  timestamps: number[]; // Array of post creation timestamps\r\n}\r\n\r\n// In-memory store: anonId -> RateLimitEntry\r\nconst rateLimitStore = new Map<string, RateLimitEntry>();\r\n\r\n// Configuration\r\nconst MAX_POSTS = 5;\r\nconst WINDOW_MS = 10 * 60 * 1000; // 10 minutes in milliseconds\r\n\r\n/**\r\n * Check if an anonymous ID has exceeded the rate limit\r\n * @param anonId - Anonymous user ID\r\n * @returns true if allowed, false if rate limited\r\n */\r\nexport function checkRateLimit(anonId: string): { allowed: boolean; remaining: number; resetAt: number } {\r\n  const now = Date.now();\r\n  const entry = rateLimitStore.get(anonId);\r\n\r\n  if (!entry) {\r\n    // First post for this user - allow it\r\n    rateLimitStore.set(anonId, { timestamps: [now] });\r\n    return {\r\n      allowed: true,\r\n      remaining: MAX_POSTS - 1,\r\n      resetAt: now + WINDOW_MS,\r\n    };\r\n  }\r\n\r\n  // Remove timestamps outside the current window\r\n  const cutoff = now - WINDOW_MS;\r\n  entry.timestamps = entry.timestamps.filter(ts => ts > cutoff);\r\n\r\n  if (entry.timestamps.length >= MAX_POSTS) {\r\n    // Rate limited - find the oldest timestamp to calculate reset time\r\n    const oldestTimestamp = Math.min(...entry.timestamps);\r\n    const resetAt = oldestTimestamp + WINDOW_MS;\r\n\r\n    return {\r\n      allowed: false,\r\n      remaining: 0,\r\n      resetAt,\r\n    };\r\n  }\r\n\r\n  // Allow the post - add current timestamp\r\n  entry.timestamps.push(now);\r\n  rateLimitStore.set(anonId, entry);\r\n\r\n  return {\r\n    allowed: true,\r\n    remaining: MAX_POSTS - entry.timestamps.length,\r\n    resetAt: now + WINDOW_MS,\r\n  };\r\n}\r\n\r\n/**\r\n * Clean up old entries from the rate limit store\r\n * Should be called periodically to prevent memory leaks\r\n */\r\nexport function cleanupRateLimitStore(): void {\r\n  const now = Date.now();\r\n  const cutoff = now - WINDOW_MS;\r\n\r\n  for (const [anonId, entry] of rateLimitStore.entries()) {\r\n    // Remove timestamps outside the window\r\n    entry.timestamps = entry.timestamps.filter(ts => ts > cutoff);\r\n\r\n    // Remove entry if no timestamps remain\r\n    if (entry.timestamps.length === 0) {\r\n      rateLimitStore.delete(anonId);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Get current rate limit status for an anonymous ID (without incrementing)\r\n * Useful for checking status before attempting to create a post\r\n */\r\nexport function getRateLimitStatus(anonId: string): { remaining: number; resetAt: number } {\r\n  const now = Date.now();\r\n  const entry = rateLimitStore.get(anonId);\r\n\r\n  if (!entry) {\r\n    return {\r\n      remaining: MAX_POSTS,\r\n      resetAt: now + WINDOW_MS,\r\n    };\r\n  }\r\n\r\n  // Remove timestamps outside the current window\r\n  const cutoff = now - WINDOW_MS;\r\n  entry.timestamps = entry.timestamps.filter(ts => ts > cutoff);\r\n\r\n  if (entry.timestamps.length === 0) {\r\n    rateLimitStore.delete(anonId);\r\n    return {\r\n      remaining: MAX_POSTS,\r\n      resetAt: now + WINDOW_MS,\r\n    };\r\n  }\r\n\r\n  const oldestTimestamp = Math.min(...entry.timestamps);\r\n  const resetAt = oldestTimestamp + WINDOW_MS;\r\n\r\n  return {\r\n    remaining: MAX_POSTS - entry.timestamps.length,\r\n    resetAt,\r\n  };\r\n}\r\n\r\n// Run cleanup every 5 minutes to prevent memory leaks\r\nif (typeof setInterval !== 'undefined') {\r\n  setInterval(cleanupRateLimitStore, 5 * 60 * 1000);\r\n}\r\n\r\n","import { RequestHandler } from 'express';\r\nimport { z } from 'zod';\r\nimport { Post } from '../models';\r\nimport { connectToDatabase } from '../lib/mongodb';\r\nimport { CreatePostZ } from '../../shared/schemas';\r\nimport { checkRateLimit } from '../lib/rateLimiter';\r\n\r\n/**\r\n * POST /api/post\r\n * Create a new post\r\n */\r\nexport const createPost: RequestHandler = async (req, res) => {\r\n  try {\r\n    await connectToDatabase();\r\n\r\n    // Validate request body with Zod\r\n    const parseResult = CreatePostZ.safeParse(req.body);\r\n    \r\n    if (!parseResult.success) {\r\n      res.status(400).json({ \r\n        error: 'Validation failed', \r\n        details: parseResult.error.flatten() \r\n      });\r\n      return;\r\n    }\r\n\r\n    const parsed = parseResult.data;\r\n\r\n    // Read anon id from cookie header (preferred) or from body (fallback)\r\n    const cookie = req.headers.cookie || '';\r\n    const cookieMatch = cookie.match(/(?:^|; )shy_anon_id=([^;]+)/);\r\n    const authorAnonId = cookieMatch \r\n      ? decodeURIComponent(cookieMatch[1]) \r\n      : parsed.authorAnonId;\r\n\r\n    if (!authorAnonId) {\r\n      res.status(400).json({ error: 'No anonymous ID found. Please enable cookies or provide authorAnonId.' });\r\n      return;\r\n    }\r\n\r\n    // Check rate limit (max 5 posts per 10 minutes per anonymous ID)\r\n    const rateLimitResult = checkRateLimit(authorAnonId);\r\n    if (!rateLimitResult.allowed) {\r\n      const resetInSeconds = Math.ceil((rateLimitResult.resetAt - Date.now()) / 1000);\r\n      res.status(429).json({ \r\n        error: 'Rate limit exceeded. Maximum 5 posts per 10 minutes.',\r\n        remaining: rateLimitResult.remaining,\r\n        resetIn: resetInSeconds,\r\n        resetAt: new Date(rateLimitResult.resetAt).toISOString(),\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Determine content type based on images\r\n    const hasImages = parsed.images.length > 0 || (parsed.imageUrl && parsed.imageUrl.trim());\r\n    const contentType = hasImages ? 'image' : 'text';\r\n\r\n    // Create the post in database\r\n    const post = await Post.create({\r\n      nickname: parsed.nickname,\r\n      text: parsed.text,\r\n      images: parsed.images,\r\n      imageUrl: parsed.imageUrl, // Legacy support\r\n      authorAnonId,\r\n      blurRequested: parsed.blurRequested,\r\n      topics: parsed.topics,\r\n      contentType,\r\n    });\r\n\r\n    // Add rate limit headers to response\r\n    res.setHeader('X-RateLimit-Remaining', rateLimitResult.remaining.toString());\r\n    res.setHeader('X-RateLimit-Reset', rateLimitResult.resetAt.toString());\r\n    res.setHeader('X-RateLimit-Limit', '5');\r\n\r\n    res.status(201).json(post);\r\n  } catch (error) {\r\n    console.error('Error creating post:', error);\r\n    \r\n    // Handle Mongoose validation errors\r\n    if (error instanceof Error && error.name === 'ValidationError') {\r\n      res.status(400).json({ error: error.message });\r\n      return;\r\n    }\r\n\r\n    // Handle Zod validation errors (shouldn't happen due to safeParse, but just in case)\r\n    if (error instanceof z.ZodError) {\r\n      res.status(400).json({ error: 'Validation failed', details: error.flatten() });\r\n      return;\r\n    }\r\n    \r\n    res.status(500).json({ error: 'Failed to create post' });\r\n  }\r\n};\r\n\r\n","import { RequestHandler } from 'express';\nimport { Post } from '../models';\nimport { connectToDatabase } from '../lib/mongodb';\n\n/**\n * GET /api/feed\n * Get paginated posts with status='auto'\n * Query params: page (default 1), limit (default 10)\n */\nexport const getFeed: RequestHandler = async (req, res) => {\n  try {\n    await connectToDatabase();\n\n    // Parse pagination parameters\n    const page = Math.max(1, parseInt(req.query.page as string) || 1);\n    const limit = Math.min(50, Math.max(1, parseInt(req.query.limit as string) || 10));\n    const skip = (page - 1) * limit;\n\n    // Get posts with status='auto' sorted by createdAt desc\n    const [posts, total] = await Promise.all([\n      Post.find({ status: 'auto' })\n        .sort({ createdAt: -1 })\n        .skip(skip)\n        .limit(limit)\n        .lean()\n        .exec(),\n      Post.countDocuments({ status: 'auto' }),\n    ]);\n\n    res.json({\n      posts,\n      total,\n      page,\n      limit,\n      totalPages: Math.ceil(total / limit),\n    });\n  } catch (error) {\n    console.error('Error fetching feed:', error);\n    res.status(500).json({ error: 'Failed to fetch feed' });\n  }\n};\n\n","import { RequestHandler } from 'express';\r\nimport { Types } from 'mongoose';\r\nimport { z } from 'zod';\r\nimport { Comment, Post } from '../models';\r\nimport { connectToDatabase } from '../lib/mongodb';\r\nimport { CreateCommentZ } from '../../shared/schemas';\r\n\r\n/**\r\n * POST /api/comment\r\n * Create a new comment and increment post's comment count\r\n */\r\nexport const createComment: RequestHandler = async (req, res) => {\r\n  try {\r\n    await connectToDatabase();\r\n\r\n    // Validate request body with Zod\r\n    const parseResult = CreateCommentZ.safeParse(req.body);\r\n    \r\n    if (!parseResult.success) {\r\n      res.status(400).json({ \r\n        error: 'Validation failed', \r\n        details: parseResult.error.flatten() \r\n      });\r\n      return;\r\n    }\r\n\r\n    const parsed = parseResult.data;\r\n\r\n    // Validate ObjectId\r\n    if (!Types.ObjectId.isValid(parsed.postId)) {\r\n      res.status(400).json({ error: 'Invalid post ID format' });\r\n      return;\r\n    }\r\n\r\n    // Check if post exists\r\n    const post = await Post.findById(parsed.postId);\r\n    if (!post) {\r\n      res.status(404).json({ error: 'Post not found' });\r\n      return;\r\n    }\r\n\r\n    // Create the comment\r\n    const comment = await Comment.create({\r\n      postId: new Types.ObjectId(parsed.postId),\r\n      nickname: parsed.nickname,\r\n      text: parsed.text,\r\n    });\r\n\r\n    // Increment post's comment count\r\n    await Post.findByIdAndUpdate(parsed.postId, {\r\n      $inc: { commentCount: 1 },\r\n    });\r\n\r\n    res.status(201).json(comment);\r\n  } catch (error) {\r\n    console.error('Error creating comment:', error);\r\n    \r\n    // Handle Mongoose validation errors\r\n    if (error instanceof Error && error.name === 'ValidationError') {\r\n      res.status(400).json({ error: error.message });\r\n      return;\r\n    }\r\n\r\n    // Handle Zod validation errors\r\n    if (error instanceof z.ZodError) {\r\n      res.status(400).json({ error: 'Validation failed', details: error.flatten() });\r\n      return;\r\n    }\r\n    \r\n    res.status(500).json({ error: 'Failed to create comment' });\r\n  }\r\n};\r\n\r\n/**\r\n * GET /api/comments?postId=<id>\r\n * Get all comments for a specific post\r\n */\r\nexport const getComments: RequestHandler = async (req, res) => {\r\n  try {\r\n    await connectToDatabase();\r\n\r\n    const { postId } = req.query;\r\n\r\n    // Validate postId\r\n    if (!postId || typeof postId !== 'string') {\r\n      res.status(400).json({ error: 'Post ID is required' });\r\n      return;\r\n    }\r\n\r\n    if (!Types.ObjectId.isValid(postId)) {\r\n      res.status(400).json({ error: 'Invalid post ID' });\r\n      return;\r\n    }\r\n\r\n    // Get comments sorted by createdAt ascending\r\n    const comments = await Comment.find({ postId: new Types.ObjectId(postId) })\r\n      .sort({ createdAt: 1 })\r\n      .lean()\r\n      .exec();\r\n\r\n    res.json(comments);\r\n  } catch (error) {\r\n    console.error('Error fetching comments:', error);\r\n    res.status(500).json({ error: 'Failed to fetch comments' });\r\n  }\r\n};\r\n\r\n","import { RequestHandler } from 'express';\r\nimport { Types } from 'mongoose';\r\nimport { z } from 'zod';\r\nimport { Post } from '../models';\r\nimport { connectToDatabase } from '../lib/mongodb';\r\nimport { ReportPostZ } from '../../shared/schemas';\r\n\r\n/**\r\n * POST /api/report\r\n * Report a post by incrementing its reportsCount\r\n */\r\nexport const reportPost: RequestHandler = async (req, res) => {\r\n  try {\r\n    await connectToDatabase();\r\n\r\n    // Validate request body with Zod\r\n    const parseResult = ReportPostZ.safeParse(req.body);\r\n    \r\n    if (!parseResult.success) {\r\n      res.status(400).json({ \r\n        error: 'Validation failed', \r\n        details: parseResult.error.flatten() \r\n      });\r\n      return;\r\n    }\r\n\r\n    const parsed = parseResult.data;\r\n\r\n    // Validate ObjectId format\r\n    if (!Types.ObjectId.isValid(parsed.postId)) {\r\n      res.status(400).json({ error: 'Invalid post ID format' });\r\n      return;\r\n    }\r\n\r\n    // Check if post exists and increment reportsCount\r\n    const post = await Post.findByIdAndUpdate(\r\n      parsed.postId,\r\n      { $inc: { reportsCount: 1 } },\r\n      { new: true }\r\n    );\r\n\r\n    if (!post) {\r\n      res.status(404).json({ error: 'Post not found' });\r\n      return;\r\n    }\r\n\r\n    res.json({ success: true, reportsCount: post.reportsCount });\r\n  } catch (error) {\r\n    console.error('Error reporting post:', error);\r\n    \r\n    // Handle Zod validation errors\r\n    if (error instanceof z.ZodError) {\r\n      res.status(400).json({ error: 'Validation failed', details: error.flatten() });\r\n      return;\r\n    }\r\n    \r\n    res.status(500).json({ error: 'Failed to report post' });\r\n  }\r\n};\r\n\r\n","import { RequestHandler } from 'express';\r\nimport { Types } from 'mongoose';\r\nimport { v2 as cloudinary } from 'cloudinary';\r\nimport { Post, Comment } from '../models';\r\nimport { connectToDatabase } from '../lib/mongodb';\r\n\r\n// Configure Cloudinary for server-side operations (delete images)\r\ncloudinary.config({\r\n  cloud_name: process.env.CLOUDINARY_CLOUD_NAME || process.env.VITE_CLOUDINARY_CLOUD_NAME,\r\n  api_key: process.env.CLOUDINARY_API_KEY,\r\n  api_secret: process.env.CLOUDINARY_API_SECRET,\r\n});\r\n\r\n/**\r\n * DELETE /api/post/:postId\r\n * Delete a post and all its comments\r\n * - Verifies post belongs to the user (via anonymous ID cookie)\r\n * - Deletes images from Cloudinary\r\n * - Deletes post and comments from database\r\n */\r\nexport const deletePost: RequestHandler = async (req, res) => {\r\n  try {\r\n    await connectToDatabase();\r\n\r\n    const { postId } = req.params;\r\n\r\n    // Validate postId\r\n    if (!postId || !Types.ObjectId.isValid(postId)) {\r\n      res.status(400).json({ error: 'Invalid post ID' });\r\n      return;\r\n    }\r\n\r\n    // Read anonymous ID from cookie\r\n    const cookie = req.headers.cookie || '';\r\n    const cookieMatch = cookie.match(/(?:^|; )shy_anon_id=([^;]+)/);\r\n    const anonId = cookieMatch ? decodeURIComponent(cookieMatch[1]) : null;\r\n\r\n    if (!anonId) {\r\n      res.status(400).json({ error: 'No anonymous ID found. Unable to verify ownership.' });\r\n      return;\r\n    }\r\n\r\n    // Check if post exists\r\n    const post = await Post.findById(postId);\r\n    if (!post) {\r\n      res.status(404).json({ error: 'Post not found' });\r\n      return;\r\n    }\r\n\r\n    // Verify the post belongs to this user\r\n    if (post.authorAnonId !== anonId) {\r\n      res.status(403).json({ error: 'Forbidden. You can only delete your own posts.' });\r\n      return;\r\n    }\r\n\r\n    // Delete images from Cloudinary if they exist\r\n    const images = post.images || [];\r\n    if (images.length > 0) {\r\n      try {\r\n        const publicIds = images.map(img => img.publicId).filter(Boolean);\r\n        if (publicIds.length > 0) {\r\n          await cloudinary.api.delete_resources(publicIds);\r\n          console.log(`Deleted ${publicIds.length} images from Cloudinary for post ${postId}`);\r\n        }\r\n      } catch (cloudinaryError) {\r\n        console.error('Error deleting images from Cloudinary:', cloudinaryError);\r\n        // Continue with post deletion even if Cloudinary cleanup fails\r\n      }\r\n    }\r\n\r\n    // Delete legacy single image if present (and not in images array)\r\n    if (post.imageUrl && images.length === 0) {\r\n      try {\r\n        // Extract public_id from URL if possible\r\n        const urlMatch = post.imageUrl.match(/\\/v\\d+\\/(.+)\\.(jpg|jpeg|png|gif|webp)/);\r\n        if (urlMatch) {\r\n          await cloudinary.uploader.destroy(urlMatch[1]);\r\n          console.log(`Deleted legacy image from Cloudinary for post ${postId}`);\r\n        }\r\n      } catch (cloudinaryError) {\r\n        console.error('Error deleting legacy image from Cloudinary:', cloudinaryError);\r\n      }\r\n    }\r\n\r\n    // Delete all comments associated with this post\r\n    await Comment.deleteMany({ postId: new Types.ObjectId(postId) });\r\n\r\n    // Delete the post\r\n    await Post.findByIdAndDelete(postId);\r\n\r\n    res.json({ \r\n      success: true, \r\n      message: 'Post and associated comments deleted successfully' \r\n    });\r\n  } catch (error) {\r\n    console.error('Error deleting post:', error);\r\n    res.status(500).json({ error: 'Failed to delete post' });\r\n  }\r\n};\r\n\r\n","import { Router } from \"express\";\r\nimport fetch from \"node-fetch\";\r\n\r\nconst router = Router();\r\nconst N8N_WEBHOOK_URL = process.env.N8N_WEBHOOK_URL || \"\";\r\n\r\nfunction pickReply(data) {\r\n  if (!data) return null;\r\n  if (typeof data.reply === \"string\" && data.reply.trim()) return data.reply;\r\n  if (Array.isArray(data) && data[0]) return pickReply(data[0]);\r\n  if (typeof data === \"string\") return data;\r\n  if (data.text) return data.text;\r\n  if (Array.isArray(data.output) &&\r\n      data.output[0]?.content &&\r\n      Array.isArray(data.output[0].content) &&\r\n      data.output[0].content[0]?.text) {\r\n    return data.output[0].content[0].text;\r\n  }\r\n  if (Array.isArray(data.choices) &&\r\n      data.choices[0]?.message?.content) {\r\n    return data.choices[0].message.content;\r\n  }\r\n  return null;\r\n}\r\n\r\nrouter.post(\"/chat\", async (req, res) => {\r\n  try {\r\n    const { sessionId, message, userMeta } = req.body;\r\n\r\n    console.log(\"ðŸ“© Incoming /api/chat body:\", req.body);\r\n\r\n    if (typeof message !== \"string\" || !message.trim()) {\r\n      return res.status(400).json({ ok: false, reply: \"Your message was empty or invalid.\" });\r\n    }\r\n\r\n    if (!N8N_WEBHOOK_URL) {\r\n      console.error(\"âŒ N8N_WEBHOOK_URL is not set\");\r\n      return res.status(500).json({ ok: false, reply: \"Server misconfigured.\" });\r\n    }\r\n\r\n    const payload = {\r\n      sessionId: String(sessionId || Date.now()),\r\n      action: \"sendMessage\",\r\n      chatInput: message.trim(),\r\n      userMeta: userMeta || {}\r\n    };\r\n\r\n    console.log(\"âž¡ï¸ Sending to n8n:\", N8N_WEBHOOK_URL, payload);\r\n\r\n    const n8nRes = await fetch(N8N_WEBHOOK_URL, {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify(payload),\r\n    });\r\n\r\n    const rawText = await n8nRes.text();\r\n    console.log(\"â¬…ï¸ Response from n8n:\", n8nRes.status, rawText);\r\n\r\n    let data;\r\n    try { data = JSON.parse(rawText); } catch { data = rawText; }\r\n    const reply = pickReply(data) || \"Sorry, I couldn't generate a reply right now.\";\r\n\r\n    return res.status(n8nRes.ok ? 200 : 502).json({ ok: !!reply, reply });\r\n  } catch (err) {\r\n    console.error(\"âŒ Error in /api/chat:\", err);\r\n    return res.status(500).json({ ok: false, reply: \"Sorry, something went wrong on the server.\" });\r\n  }\r\n});\r\n\r\nexport default router;\r\n","import \"dotenv/config\";\r\nimport express from \"express\";\r\nimport cors from \"cors\";\r\nimport { handleDemo } from \"./routes/demo\";\r\nimport { createPost } from \"./routes/post\";\r\nimport { getFeed } from \"./routes/feed\";\r\nimport { createComment, getComments } from \"./routes/comment\";\r\nimport { reportPost } from \"./routes/report\";\r\nimport { deletePost } from \"./routes/delete\";\r\nimport chatRouter from \"./routes/chat\";\r\n\r\nexport function createServer() {\r\n  const app = express();\r\n\r\n  // Middleware\r\n  app.use(cors());\r\n  app.use(express.json());\r\n  app.use(express.urlencoded({ extended: true }));\r\n\r\n  // Example API routes\r\n  app.get(\"/api/health\", (_req, res) => {\r\n    res.json({ ok: true });\r\n  });\r\n\r\n  app.get(\"/api/ping\", (_req, res) => {\r\n    const ping = process.env.PING_MESSAGE ?? \"ping\";\r\n    res.json({ message: ping });\r\n  });\r\n\r\n  app.get(\"/api/demo\", handleDemo);\r\n\r\n  // Chatbot API route\r\n  app.use(\"/api\", chatRouter);\r\n\r\n  // Community API routes\r\n  app.post(\"/api/post\", createPost);\r\n  app.get(\"/api/feed\", getFeed);\r\n  app.post(\"/api/comment\", createComment);\r\n  app.get(\"/api/comments\", getComments);\r\n  app.post(\"/api/report\", reportPost);\r\n  app.delete(\"/api/post/:postId\", deletePost);\r\n\r\n  return app;\r\n}\r\n","import path from \"path\";\nimport express from \"express\";\nimport { createServer } from \"./index\";\n\nconst app = createServer();\nconst port = process.env.PORT || 3000;\n\n// Resolve current directory (for ESM)\nconst __dirname = import.meta.dirname;\n\n// Path to your built frontend files\nconst distPath = path.join(__dirname, \"../spa\");\n\n// Serve static assets (React/Vite/Next build output)\napp.use(express.static(distPath));\n\n/**\n * Simple health check route for Render\n */\napp.get(\"/health\", (_req, res) => {\n  res.json({ ok: true });\n});\n\n/**\n * SPA fallback:\n * Serve index.html for any non-API route\n * (avoids path-to-regexp error from app.get(\"*\"))\n */\napp.get(/^(?!\\/api\\/|\\/health).*/, (_req, res) => {\n  res.sendFile(path.join(distPath, \"index.html\"));\n});\n\napp.listen(port, () => {\n  console.log(`ðŸš€ SHY Community server running on port ${port}`);\n  console.log(`ðŸŒ Frontend available at http://localhost:${port}`);\n  console.log(`ðŸ”§ API base URL: http://localhost:${port}/api`);\n});\n\n/**\n * Graceful shutdown handlers\n */\nprocess.on(\"SIGTERM\", () => {\n  console.log(\"ðŸ›‘ Received SIGTERM, shutting down gracefully\");\n  process.exit(0);\n});\n\nprocess.on(\"SIGINT\", () => {\n  console.log(\"ðŸ›‘ Received SIGINT, shutting down gracefully\");\n  process.exit(0);\n});\n"],"names":["cloudinary","app","chatRouter"],"mappings":"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"}